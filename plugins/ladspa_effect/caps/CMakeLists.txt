INCLUDE_DIRECTORIES("${CMAKE_SOURCE_DIR}/include")
FILE(GLOB SOURCES *.cc)
ADD_LIBRARY(caps MODULE ${SOURCES})
INSTALL(TARGETS caps LIBRARY DESTINATION ${PLUGIN_DIR}/ladspa)

SET_TARGET_PROPERTIES(caps PROPERTIES PREFIX "")
EXEC_PROGRAM(${CMAKE_C_COMPILER} ARGS --version OUTPUT_VARIABLE _gcc_version_info)
STRING(REGEX MATCH "4\\.1\\.[0-9]" _gcc_is_4_1_x "${_gcc_version_info}")
STRING(LENGTH "${_gcc_is_4_1_x}" NO_O3)
IF(NO_O3)
	MESSAGE("Found GCC 4.1.x - compiling CAPS-plugins with -O2 instead of -O3")
	SET_TARGET_PROPERTIES(caps PROPERTIES COMPILE_FLAGS "-Wno-write-strings")
ELSE(NO_O3)
	SET_TARGET_PROPERTIES(caps PROPERTIES COMPILE_FLAGS "-O3 -Wno-write-strings -msse -msse2 -msse3")
ENDIF(NO_O3)

IF(LMMS_BUILD_WIN32)
	ADD_CUSTOM_COMMAND(TARGET caps POST_BUILD COMMAND /opt/mingw/bin/i586-mingw32-strip ${CMAKE_CURRENT_BINARY_DIR}/caps.dll)
ENDIF(LMMS_BUILD_WIN32)

IF(LMMS_BUILD_APPLE)
	SET_TARGET_PROPERTIES(caps PROPERTIES LINK_FLAGS "${LINK_FLAGS} -shared -no-undefined")
ELSE(LMMS_BUILD_APPLE)
	SET_TARGET_PROPERTIES(caps PROPERTIES LINK_FLAGS "${LINK_FLAGS} -shared -Wl,-no-undefined")
ENDIF(LMMS_BUILD_APPLE)

IF(LMMS_BUILD_LINUX)
	SET_TARGET_PROPERTIES(caps PROPERTIES LINK_FLAGS "${LINK_FLAGS} -nostartfiles")
ENDIF(LMMS_BUILD_LINUX)

